<!DOCTYPE html>
<meta charset="UTF-8">
<html xmlns:th="http://www.thymeleaf.org">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" th:href="@{ /css/communityboard/communityboard.css}">
    <link rel="stylesheet" type="text/css" th:href="@{ /css/communityboard/selectone.css}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

    <div>
        <h2>게시글</h2>
        <br>
        <div>
            <table>
                <tr style="border-top-left-radius: 10px; border-bottom-left-radius: 10px;">
                    <td colspan="2"><p th:text="${ board.boardCategory }"></p></td>
                </tr>
                <tr>
                    <td colspan="2"> 제목 | <p th:text="${ board.title }"></p></td>
                </tr>
                <tr class="view-id-date">
                    <td style="border-top-left-radius: 10px; border-bottom-left-radius: 10px; text-align: left;">작성자 |<span th:text="${ board.userId.nickname }"></span></td>
                    <td style="border-top-right-radius: 10px; border-bottom-right-radius: 10px; text-align: right;">작성일 |<span th:text="${ board.postedDate }"></span></td>
                </tr>
                <tr>
                    <td>내용</td>
                    <td colspan="2"><textarea th:text="${ board.boardContent }"></textarea></td>
                </tr>
                <tr>
                    <td colspan="2"><button type="button" style="text-align: right;">신고하기</button></td>
                </tr>
            </table>
            <div>
                <button type="button" class="insert-button" id="btnModify">수정하기</button>
                <button type="button" class="insert-button" id="btnDelete">삭제하기</button>
            </div>
            <div>
                <button type="button" class="insert-button" th:onclick="'location.href=\'/board/searchList\''">
                    돌아가기
                </button>
            </div>

            <table id="commentInsert">
                <input type="hidden" id="boardNo" name="boardCode" th:value="${ board.boardCode }">
                <tr>
                    <td>댓글</td>
                    <td>
                        <textarea cols="40" rows="3" id="commentContent" style="resize: none;"></textarea>
                    </td>
                    <td>
                        <button type="button" id="insertComment">댓글작성</button>
                    </td>
                </tr>
            </table>

            <table id="commentResult">
                <th:block th:if="${ commentList != null }">
                    <th:block th:each="memberComment : ${ commentList }">
                        <tr class="table-td1">
                            <input type="hidden" id="${ memberComment.commentCode }" th:value="${ memberComment.commentCode }">
                            <td style="border-top-left-radius: 10px; border-bottom-left-radius: 10px;"
                                th:text="${ memberComment.commentContent }"></td>
                            <td th:text="${ memberComment.userId }"></td>
                            <td style="border-top-right-radius: 10px; border-bottom-right-radius: 10px;"
                                th:text="${ memberComment.postedDate }"></td>
                            <td>
                                <th:block> <!--sec:authorize="isAuthenticated()"
                                            th:if="${ #authentication.getPrincipal().getMemberNo() == reply.writer.memberNo }"-->
                                    <button type="button"
                                            th:commentNo="${ memberComment.commentCode }"
                                            th:onclick="commentDelete(this.getAttribute('commentNo'))">댓글삭제</button>
                                </th:block>
                            </td>
                        </tr>
                    </th:block>
                </th:block>
            </table>
        </div>
    </div>


    <script th:inline="javascript">

        /* 게시글 수정 */
        $('#btnModify').click(function (){
            const boardCode = document.getElementById("boardNo").value;
            location.href = "/board/boardModify?boardCode=" + boardCode;
        });

        /* 게시글 삭제 */
        $('#btnDelete').click(function (){

            const boardCode = '[[${board.boardCode}]]';
            if(!confirm('정말로 게시글을 삭제하시겠습니까?')) {
                return false;
            }

            const formHtml = `
                    <form id="deleteForm" action="/board/boardDelete" method="post">
                        <input type="hidden" id="boardCode" name="boardCode" value="${boardCode}"/>
                    </form>
                `;
            const doc = new DOMParser().parseFromString(formHtml, 'text/html');
            const form = doc.body.firstChild;
            document.body.append(form);
            document.getElementById('deleteForm').submit();
        });

        /* 댓글 등록 */
        if(document.getElementById("insertComment")) {

            const $insertComment = document.getElementById("insertComment");
            const $commentContent = document.getElementById("commentContent");

            $insertComment.onclick = function() {

                if($commentContent.value.trim() == ""){
                    alert('댓글을 입력해 주세요');
                    return ;
                }

                let boardNo = document.getElementById("boardNo").value;
                let commentContent = document.getElementById("commentContent").value;

                fetch("/board/commentPosting", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json;charset=UTF-8'
                    },
                    body: JSON.stringify(
                        {
                            userId: 'a123!',
                            boardCode: boardNo,
                            commentContent: commentContent
                        }
                    )
                })
                    .then(result => result.json())
                    .then(data => {
                        const $table = $("#commentResult");
                        $table.html("");

                        data.map((memberComment) => {
                            $tr = $("<tr>");
                            $commentContentTd = $("<td>").text(memberComment.commentContent);
                            $userIdTd = $("<td>").text(memberComment.userId);
                            $postedDateTd = $("<td>").text(memberComment.postedDate);
                            $removeTd = $("<td>").append("<button type='button' onclick='commentDelete(" + memberComment.commentCode + ")'>댓글삭제</button>");


                            $tr.append("<input type='hidden' id=" + memberComment.commentCode + " value='" + memberComment.commentCode + "'>");
                            $tr.append($commentContentTd);
                            $tr.append($userIdTd);
                            $tr.append($postedDateTd);
                            $tr.append($removeTd);

                            $table.append($tr);
                        });

                    })
                    .catch((error) => error.text().then((res) => alert(res)));
            }
        }


        async function commentDelete(commentNo){

            let boardNo = document.getElementById("boardNo").value;

            if(!confirm('정말로 댓글을 삭제하시겠습니까?')) {
                return false;
            }

            await fetch("/board/commentDelete", {
                method: "PATCH",
                headers: {
                    'Content-Type': 'application/json;charset=UTF-8'
                },
                body: JSON.stringify(
                    {
                        BoardCode:boardNo,
                        commentCode:commentNo
                    }
                )
            })
                .then(result => result.json())
                .then(data => {
                    console.table(data);

                    const $table = $("#commentResult");
                    $table.html("");

                    data.map((memberComment) => {
                        $tr = $("<tr>");
                        $commentContentTd = $("<td>").text(memberComment.commentContent);
                        $userIdTd = $("<td>").text(memberComment.userId);
                        $postedDateTd = $("<td>").text(memberComment.postedDate);
                        $removeTd = $("<td>").append("<button type='button' onclick='commentDelete(" + memberComment.commentCode + ")'>댓글삭제</button>");


                        $tr.append("<input type='hidden' id=" + memberComment.commentCode + " value='" + memberComment.commentCode + "'>");
                        $tr.append($commentContentTd);
                        $tr.append($userIdTd);
                        $tr.append($postedDateTd);
                        $tr.append($removeTd);

                        $table.append($tr);

                    })


                })
                .catch((error) => error.text().then((res) => alert(res)));
        }
    </script>
</html>